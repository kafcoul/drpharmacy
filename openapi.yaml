# API Documentation - DR-PHARMA
# OpenAPI 3.0 Specification

openapi: 3.0.3
info:
  title: DR-PHARMA API
  description: |
    API for the DR-PHARMA multi-pharmacy delivery platform in Côte d'Ivoire.

    ## Features
    - Multi-role authentication (Customer, Pharmacy, Courier, Admin)
    - Product catalog with search and filtering
    - Order management with real-time status updates
    - GPS-based courier assignment (Haversine algorithm)
    - Integrated payment gateways (CinetPay, Jèko)
    - Commission distribution system
    - Notification system (Email, SMS, FCM)

    ## Authentication
    All protected endpoints require Bearer token authentication via Laravel Sanctum.
    Include the token in the Authorization header: `Authorization: Bearer {token}`

  version: 1.0.0
  contact:
    name: DR-PHARMA Support
    email: support@drpharma.ci

servers:
  - url: http://localhost:8000/api
    description: Local development server
  - url: https://api.drpharma.ci/api
    description: Production server

tags:
  - name: Authentication
    description: User registration, login, and profile management
  - name: Products
    description: Product catalog and search
  - name: Orders
    description: Order creation and management
  - name: Deliveries
    description: Courier delivery workflow
  - name: Payments
    description: Payment processing and commission
  - name: Pharmacies
    description: Pharmacy management
  - name: Admin
    description: Administrative endpoints

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    User:
      type: object
      properties:
        id:
          type: integer
          example: 1
        name:
          type: string
          example: "John Doe"
        email:
          type: string
          format: email
          example: "john@example.com"
        phone:
          type: string
          example: "+225 07 00 00 00 01"
        role:
          type: string
          enum: [customer, pharmacy, courier, admin]
          example: "customer"
        address:
          type: string
          nullable: true
        created_at:
          type: string
          format: date-time

    Product:
      type: object
      properties:
        id:
          type: integer
        name:
          type: string
          example: "Paracétamol 500mg"
        slug:
          type: string
        category:
          type: string
          example: "analgesics"
        description:
          type: string
        price:
          type: number
          format: float
          example: 1500
        stock_quantity:
          type: integer
          example: 100
        requires_prescription:
          type: boolean
        is_available:
          type: boolean
        pharmacy:
          $ref: "#/components/schemas/Pharmacy"

    Pharmacy:
      type: object
      properties:
        id:
          type: integer
        name:
          type: string
          example: "Pharmacie Centrale"
        license_number:
          type: string
        address:
          type: string
        phone:
          type: string
        latitude:
          type: number
          format: float
        longitude:
          type: number
          format: float
        status:
          type: string
          enum: [pending, approved, suspended]

    Order:
      type: object
      properties:
        id:
          type: integer
        order_number:
          type: string
          example: "ORD-ABC12345"
        customer_id:
          type: integer
        pharmacy_id:
          type: integer
        status:
          type: string
          enum: [pending, confirmed, ready, in_transit, delivered, cancelled]
        total_amount:
          type: number
          format: float
        delivery_address:
          type: string
        delivery_latitude:
          type: number
        delivery_longitude:
          type: number
        items:
          type: array
          items:
            $ref: "#/components/schemas/OrderItem"

    OrderItem:
      type: object
      properties:
        id:
          type: integer
        product_id:
          type: integer
        quantity:
          type: integer
        price:
          type: number
        subtotal:
          type: number

    Error:
      type: object
      properties:
        message:
          type: string
        errors:
          type: object
          additionalProperties:
            type: array
            items:
              type: string

paths:
  # ==================== AUTHENTICATION ====================
  /auth/register/customer:
    post:
      tags:
        - Authentication
      summary: Register a new customer
      operationId: registerCustomer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - name
                - email
                - password
                - phone
              properties:
                name:
                  type: string
                  example: "Jean Kouassi"
                email:
                  type: string
                  format: email
                password:
                  type: string
                  format: password
                  minLength: 8
                password_confirmation:
                  type: string
                  format: password
                phone:
                  type: string
                  pattern: '^\+225\s?\d{2}\s?\d{2}\s?\d{2}\s?\d{2}$'
                address:
                  type: string

      responses:
        "201":
          description: Customer registered successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  user:
                    $ref: "#/components/schemas/User"
                  token:
                    type: string

        "422":
          description: Validation error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /auth/login:
    post:
      tags:
        - Authentication
      summary: Login user
      operationId: login
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - email
                - password
              properties:
                email:
                  type: string
                  format: email
                password:
                  type: string
                  format: password

      responses:
        "200":
          description: Login successful
          content:
            application/json:
              schema:
                type: object
                properties:
                  user:
                    $ref: "#/components/schemas/User"
                  token:
                    type: string
                  role_data:
                    type: object
                    description: Additional role-specific data (pharmacy/courier details)

        "401":
          description: Invalid credentials

  /auth/logout:
    post:
      tags:
        - Authentication
      summary: Logout user
      security:
        - bearerAuth: []
      responses:
        "200":
          description: Logout successful

  /auth/me:
    get:
      tags:
        - Authentication
      summary: Get authenticated user profile
      security:
        - bearerAuth: []
      responses:
        "200":
          description: User profile retrieved
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/User"

  # ==================== PRODUCTS ====================
  /products:
    get:
      tags:
        - Products
      summary: List all products (public)
      parameters:
        - name: search
          in: query
          schema:
            type: string
          description: Search by product name
        - name: category
          in: query
          schema:
            type: string
          description: Filter by category
        - name: pharmacy_id
          in: query
          schema:
            type: integer
          description: Filter by pharmacy
        - name: min_price
          in: query
          schema:
            type: number
        - name: max_price
          in: query
          schema:
            type: number
        - name: page
          in: query
          schema:
            type: integer
            default: 1

      responses:
        "200":
          description: Products list
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: "#/components/schemas/Product"
                  meta:
                    type: object
                    properties:
                      current_page:
                        type: integer
                      total:
                        type: integer

  /products/{id}:
    get:
      tags:
        - Products
      summary: Get product details
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        "200":
          description: Product details
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Product"
        "404":
          description: Product not found

  # ==================== ORDERS ====================
  /orders:
    post:
      tags:
        - Orders
      summary: Create a new order (Customer only)
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - pharmacy_id
                - items
                - delivery_address
                - delivery_latitude
                - delivery_longitude
              properties:
                pharmacy_id:
                  type: integer
                items:
                  type: array
                  items:
                    type: object
                    properties:
                      product_id:
                        type: integer
                      quantity:
                        type: integer
                        minimum: 1
                delivery_address:
                  type: string
                delivery_latitude:
                  type: number
                  minimum: -90
                  maximum: 90
                delivery_longitude:
                  type: number
                  minimum: -180
                  maximum: 180
                notes:
                  type: string

      responses:
        "201":
          description: Order created successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Order"
        "422":
          description: Validation error (e.g., insufficient stock)

    get:
      tags:
        - Orders
      summary: Get user's orders
      security:
        - bearerAuth: []
      parameters:
        - name: status
          in: query
          schema:
            type: string
            enum: [pending, confirmed, ready, in_transit, delivered, cancelled]
      responses:
        "200":
          description: Orders list
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Order"

  /orders/{id}:
    get:
      tags:
        - Orders
      summary: Get order details
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        "200":
          description: Order details
        "404":
          description: Order not found

  /orders/{id}/cancel:
    post:
      tags:
        - Orders
      summary: Cancel order (Customer only, before 'ready' status)
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        "200":
          description: Order cancelled
        "400":
          description: Cannot cancel order at this stage

  # ==================== DELIVERIES ====================
  /deliveries/available:
    get:
      tags:
        - Deliveries
      summary: Get available deliveries (Courier only)
      security:
        - bearerAuth: []
      responses:
        "200":
          description: Available deliveries list

  /deliveries/{id}/accept:
    post:
      tags:
        - Deliveries
      summary: Accept delivery (Courier only)
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        "200":
          description: Delivery accepted

  /deliveries/{id}/pickup:
    post:
      tags:
        - Deliveries
      summary: Mark order as picked up (Courier only)
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        "200":
          description: Order picked up

  /deliveries/{id}/deliver:
    post:
      tags:
        - Deliveries
      summary: Mark order as delivered (Courier only)
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        "200":
          description: Order delivered

  /courier/location:
    post:
      tags:
        - Deliveries
      summary: Update courier location
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - latitude
                - longitude
              properties:
                latitude:
                  type: number
                longitude:
                  type: number
      responses:
        "200":
          description: Location updated

  # ==================== PAYMENTS ====================
  /payments/intents:
    post:
      tags:
        - Payments
      summary: Create payment intent
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - order_id
                - gateway
              properties:
                order_id:
                  type: integer
                gateway:
                  type: string
                  enum: [cinetpay, jeko]
                phone:
                  type: string
                  description: Mobile money number
      responses:
        "200":
          description: Payment intent created
          content:
            application/json:
              schema:
                type: object
                properties:
                  payment_url:
                    type: string
                  payment_id:
                    type: string

  /webhooks/cinetpay:
    post:
      tags:
        - Payments
      summary: CinetPay webhook (public)
      description: Handles payment notifications from CinetPay
      requestBody:
        content:
          application/json:
            schema:
              type: object
      responses:
        "200":
          description: Webhook processed

  /webhooks/jeko:
    post:
      tags:
        - Payments
      summary: Jèko webhook (public)
      description: Handles payment notifications from Jèko
      responses:
        "200":
          description: Webhook processed

  # ==================== PHARMACIES ====================
  /pharmacies:
    get:
      tags:
        - Pharmacies
      summary: List all approved pharmacies (public)
      responses:
        "200":
          description: Pharmacies list
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Pharmacy"

  /pharmacies/{id}:
    get:
      tags:
        - Pharmacies
      summary: Get pharmacy details
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        "200":
          description: Pharmacy details
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Pharmacy"

security:
  - bearerAuth: []
